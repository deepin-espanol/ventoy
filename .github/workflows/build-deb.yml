name: Build Ventoy DEB Package

on:
  workflow_dispatch: # Permite ejecuci칩n manual
  schedule:
    - cron: "0 0 * * 0" # Ejecutar semanalmente los domingos a medianoche

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl jq dpkg-dev

      - name: Get latest Ventoy version
        id: ventoy_version
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/ventoy/Ventoy/releases/latest)
          VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name' | sed 's/^v//')
          DOWNLOAD_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | contains("linux.tar.gz")) | .browser_download_url')

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "Latest Ventoy version: $VERSION"
          echo "Download URL: $DOWNLOAD_URL"

      - name: Download and extract Ventoy
        run: |
          wget -O ventoy.tar.gz "${{ steps.ventoy_version.outputs.download_url }}"
          tar -xzf ventoy.tar.gz
          VENTOY_DIR=$(tar -tzf ventoy.tar.gz | head -1 | cut -f1 -d"/")
          echo "VENTOY_DIR=$VENTOY_DIR" >> $GITHUB_ENV

      - name: Prepare package structure
        run: |
          # Limpiar directorio de destino si existe
          rm -rf data/opt/apps/ventoy/*

          # Copiar archivos de Ventoy a la estructura del paquete
          mkdir -p data/opt/apps/ventoy
          cp -r $VENTOY_DIR/* data/opt/apps/ventoy/

          # Establecer permisos correctos
          chmod +x data/opt/apps/ventoy/Ventoy2Disk.sh
          chmod +x data/opt/apps/ventoy/VentoyWeb.sh
          chmod +x data/opt/apps/ventoy/VentoyGUI.*
          chmod +x data/opt/apps/ventoy/VentoyPlugson.sh
          chmod +x data/opt/apps/ventoy/*.sh

      - name: Calculate installed size
        id: package_size
        run: |
          INSTALLED_SIZE=$(du -sk data | cut -f1)
          echo "installed_size=$INSTALLED_SIZE" >> $GITHUB_OUTPUT
          echo "Installed size: $INSTALLED_SIZE KB"

      - name: Update control file
        run: |
          VERSION="${{ steps.ventoy_version.outputs.version }}"
          INSTALLED_SIZE="${{ steps.package_size.outputs.installed_size }}"

          sed -i "s/^Version:.*/Version: $VERSION-1+deepines/" control/control
          sed -i "s/^Installed-Size:.*/Installed-Size: $INSTALLED_SIZE/" control/control

      - name: Generate MD5 checksums
        run: |
          cd data
          find . -type f -exec md5sum {} \; > ../control/md5sums
          cd ..

      - name: Build DEB package
        run: |
          VERSION="${{ steps.ventoy_version.outputs.version }}"
          PACKAGE_NAME="ventoy_${VERSION}-1+deepines_amd64"

          # Crear estructura temporal para dpkg-deb
          mkdir -p "$PACKAGE_NAME/DEBIAN"
          cp -r control/* "$PACKAGE_NAME/DEBIAN/"
          cp -r data/* "$PACKAGE_NAME/"

          # Construir el paquete
          dpkg-deb --build "$PACKAGE_NAME"

          echo "PACKAGE_FILE=${PACKAGE_NAME}.deb" >> $GITHUB_ENV

      - name: Upload DEB package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ventoy-deb-package
          path: "*.deb"
          retention-days: 90

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.ventoy_version.outputs.version }}
          name: Ventoy ${{ steps.ventoy_version.outputs.version }} DEB Package
          body: |
            Paquete DEB de Ventoy ${{ steps.ventoy_version.outputs.version }} para Debian/Ubuntu

            Construido autom치ticamente desde la versi칩n oficial de Ventoy.

            **Instalaci칩n:**
            ```bash
            sudo dpkg -i ${{ env.PACKAGE_FILE }}
            sudo apt-get install -f
            ```
          files: "*.deb"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
