name: Build Ventoy DEB Package

on:
  workflow_dispatch: # Permite ejecuci贸n manual
  schedule:
    - cron: "0 0 * * 0" # Ejecutar semanalmente los domingos a medianoche

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl jq dpkg-dev

      - name: Get latest Ventoy version
        id: ventoy_version
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/ventoy/Ventoy/releases/latest)
          VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name' | sed 's/^v//')
          DOWNLOAD_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | contains("linux.tar.gz")) | .browser_download_url')

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "Latest Ventoy version: $VERSION"
          echo "Download URL: $DOWNLOAD_URL"

      - name: Download and extract Ventoy
        run: |
          wget -O ventoy.tar.gz "${{ steps.ventoy_version.outputs.download_url }}"
          tar -xzf ventoy.tar.gz

          # Obtener el nombre del directorio extra铆do (buscar ventoy-*)
          VENTOY_DIR=$(ls -d ventoy-* 2>/dev/null | head -1)

          # Verificar que se obtuvo un nombre v谩lido
          if [ -z "$VENTOY_DIR" ] || [ ! -d "$VENTOY_DIR" ]; then
            echo "Error: No se pudo encontrar el directorio de Ventoy"
            echo "Contenido del directorio actual:"
            ls -la
            exit 1
          fi

          echo "VENTOY_DIR=$VENTOY_DIR" >> $GITHUB_ENV
          echo "Ventoy directory found: $VENTOY_DIR"
          echo "Contents:"
          ls -la "$VENTOY_DIR" | head -10

      - name: Prepare package structure
        run: |
          # Crear directorio temporal para construcci贸n
          BUILD_DIR="build_temp"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR/opt/apps/ventoy"

          # Copiar archivos de Ventoy
          cp -r $VENTOY_DIR/* "$BUILD_DIR/opt/apps/ventoy/"

          # Copiar estructura de datos existente (iconos, desktop, etc)
          cp -r data/usr "$BUILD_DIR/"

          # Establecer permisos correctos
          find "$BUILD_DIR/opt/apps/ventoy" -name "*.sh" -exec chmod +x {} \;
          chmod +x "$BUILD_DIR/opt/apps/ventoy/VentoyGUI."* 2>/dev/null || true

          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

      - name: Calculate installed size
        id: package_size
        run: |
          INSTALLED_SIZE=$(du -sk $BUILD_DIR | cut -f1)
          echo "installed_size=$INSTALLED_SIZE" >> $GITHUB_OUTPUT
          echo "Installed size: $INSTALLED_SIZE KB"

      - name: Update control file
        run: |
          VERSION="${{ steps.ventoy_version.outputs.version }}"
          INSTALLED_SIZE="${{ steps.package_size.outputs.installed_size }}"

          sed -i "s/^Version:.*/Version: $VERSION-1+deepines/" control/control
          sed -i "s/^Installed-Size:.*/Installed-Size: $INSTALLED_SIZE/" control/control

      - name: Generate MD5 checksums
        run: |
          cd $BUILD_DIR
          find . -type f -exec md5sum {} \; > ../control/md5sums
          cd ..

      - name: Build DEB package
        run: |
          VERSION="${{ steps.ventoy_version.outputs.version }}"
          PACKAGE_NAME="ventoy_${VERSION}-1+deepines_amd64"

          # Crear estructura para dpkg-deb
          mkdir -p "$PACKAGE_NAME/DEBIAN"
          cp -r control/* "$PACKAGE_NAME/DEBIAN/"
          cp -r $BUILD_DIR/* "$PACKAGE_NAME/"

          # Construir el paquete
          dpkg-deb -Zxz -z9 --build --root-owner-group "$PACKAGE_NAME"

          # Guardar informaci贸n del paquete
          echo "PACKAGE_FILE=${PACKAGE_NAME}.deb" >> $GITHUB_ENV
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

          # Verificar el paquete
          echo "=== Package Info ==="
          dpkg-deb --info "${PACKAGE_NAME}.deb"
          echo ""
          echo "=== Package Contents (first 20 files) ==="
          dpkg-deb --contents "${PACKAGE_NAME}.deb" | head -20
          echo ""
          echo "=== Package Size ==="
          ls -lh "${PACKAGE_NAME}.deb"

      - name: Upload DEB package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ventoy-deb-${{ steps.ventoy_version.outputs.version }}
          path: "*.deb"
          retention-days: 90
          compression-level: 0

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.ventoy_version.outputs.version }}
          name: Ventoy ${{ steps.ventoy_version.outputs.version }} - Paquete DEB
          body: |
            #  Ventoy ${{ steps.ventoy_version.outputs.version }} - Paquete DEB para Deepin/Debian/Ubuntu

            Paquete Debian construido autom谩ticamente desde la [versi贸n oficial de Ventoy](https://github.com/ventoy/Ventoy/releases/tag/v${{ steps.ventoy_version.outputs.version }}).

            ##  Instalaci贸n

            ```bash
            # Descargar el paquete
            wget https://github.com/deepin-espanol/ventoy/releases/download/v${{ steps.ventoy_version.outputs.version }}/${{ env.PACKAGE_FILE }}

            # Instalar
            sudo dpkg -i ${{ env.PACKAGE_FILE }}
            sudo apt-get install -f
            ```

            ##  Uso

            Despu茅s de la instalaci贸n, ejecuta Ventoy desde:
            - **Men煤 de aplicaciones**: Busca "Ventoy"
            - **Terminal**: `/opt/apps/ventoy/VentoyGUI.x86_64`

            ##  Informaci贸n del Paquete

            - **Versi贸n**: ${{ steps.ventoy_version.outputs.version }}-1+deepines
            - **Arquitectura**: amd64
            - **Mantenedor**: Deepin en Espa帽ol
            - **Licencia**: GPL v3+

            ##  Enlaces

            - [Ventoy Oficial](https://www.ventoy.net/)
            - [Repositorio Ventoy](https://github.com/ventoy/Ventoy)
            - [Documentaci贸n](https://www.ventoy.net/en/doc_start.html)
          files: "*.deb"
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
